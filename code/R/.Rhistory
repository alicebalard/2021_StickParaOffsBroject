## Remove 1 factor by turn - backwards simplification
# adonis2(data.dist ~ outcome + Sex, data = metadata, permutations = perm)
#
# adonis2(data.dist ~ PAT + Sex, data = metadata, permutations = perm)
#
# adonis2(data.dist ~ PAT + outcome, data = metadata, permutations = perm)
## --> We found significant differences in global methylation due to
## paternal treatment and sex; outcome is not.
}
## Let's run Adonis
myadonisFUN(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
############################
makeDatadistFUN <- function(dataset){
# creates a matrix containing percent methylation values
perc.meth=percMethylation(dataset)
# KOSTAS MBE: "Methylated sites and regions with low variation
# and a standard deviation below 0.3, that is, noninformative
# sites across individuals, were excluded from the cluster analyses"
SD=apply(perc.meth,1, sd, na.rm = TRUE)
perc.meth <- perc.meth[-which(SD<0.3),]
x=t(perc.meth)
# creates a distance matrix. Method: Bray-Curtis, package vegan
data.dist = as.matrix((vegdist(x, "bray", upper = FALSE)))
}
myadonisFUN <- function(dataset, metadata){
data.dist = makeDatadistFUN(dataset)
# We use a PERMANOVA to test the hypothesis that paternal treatment,
# family and sex induced changes in genome-wide methylation.
# We used Euclidian distance matrix between methylation frequencies
# and the function Adonis from the R package vegan:
## Within each family, are paternal treatment, offspring treatment, sex and their interactions
## significantly influencing global methylation?
perm <- how(nperm = 1000) # 1000 permutations
setBlocks(perm) <- with(metadata, Family) # define the permutation structure
## Full model
print(adonis2(data.dist ~ PAT * outcome * Sex, data = metadata, permutations = perm))
## remove the non significant interactions
print(adonis2(data.dist ~ PAT + outcome + Sex, data = metadata, permutations = perm))
## Remove 1 factor by turn - backwards simplification
# adonis2(data.dist ~ outcome + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + outcome, data = metadata, permutations = perm)
}
## Let's run Adonis
myadonisFUN(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
# make distance matrix with B-C distances
data.dist = makeDatadistFUN(dataset)
########## NMDS
myGOF.NMDS.FUN <- function(dataset){
# make distance matrix with B-C distances
data.dist = makeDatadistFUN(dataset)
# find the best number of dimensions
library(goeveg)
## Clarke 1993 suggests the following guidelines for acceptable stress values: <0.05 = excellent, <0.10
# = good, <0.20 = usable, >0.20 = not acceptable. The plot shows the border of the 0.20 stress value
# limit. Solutions with higher stress values should be interpreted with caution and those with stress
# above 0.30 are highly suspect
dimcheckMDS(
data.dist,
distance = "bray",
k = 7,
trymax = 100,
autotransform = TRUE
)
abline(h = 0.1, col = "darkgreen")
# Goodness of fit for NMDS suggested the presence of six dimensions
# with a stress value <0.1
}
myGOF.NMDS.FUN(dataset = uniteCovALL_woSexAndUnknowChr_OFF)
makeDatadistFUN <- function(dataset){
x=makePercentMetMat(dataset)
# creates a distance matrix. Method: Bray-Curtis, package vegan
data.dist = as.matrix((vegdist(x, "bray", upper = FALSE)))
}
myadonisFUN <- function(dataset, metadata){
# make distance matrix with B-C distances
data.dist = makeDatadistFUN(dataset)
# We use a PERMANOVA to test the hypothesis that paternal treatment,
# offspring treatment, sex and their interactions significantly influencing global methylation
perm <- how(nperm = 1000) # 1000 permutations
setBlocks(perm) <- with(metadata, Family) # define the permutation structure considering family
## Full model
print(adonis2(data.dist ~ PAT * outcome * Sex, data = metadata, permutations = perm))
## remove the non significant interactions
print(adonis2(data.dist ~ PAT + outcome + Sex, data = metadata, permutations = perm))
## Remove 1 factor by turn - backwards simplification
# adonis2(data.dist ~ outcome + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + outcome, data = metadata, permutations = perm)
}
## Let's run Adonis
myadonisFUN(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
############################
makePercentMetMat <- function(dataset){
# creates a matrix containing percent methylation values
perc.meth=percMethylation(dataset)
# KOSTAS MBE: "Methylated sites and regions with low variation
# and a standard deviation below 0.3, that is, noninformative
# sites across individuals, were excluded from the cluster analyses"
SD=apply(perc.meth,1, sd, na.rm = TRUE)
perc.meth <- perc.meth[-which(SD<0.3),]
x=t(perc.meth)
return(x)
}
makeDatadistFUN <- function(dataset){
x=makePercentMetMat(dataset)
# creates a distance matrix. Method: Bray-Curtis, package vegan
data.dist = as.matrix((vegdist(x, "bray", upper = FALSE)))
}
myadonisFUN <- function(dataset, metadata){
# make distance matrix with B-C distances
data.dist = makeDatadistFUN(dataset)
# We use a PERMANOVA to test the hypothesis that paternal treatment,
# offspring treatment, sex and their interactions significantly influencing global methylation
perm <- how(nperm = 1000) # 1000 permutations
setBlocks(perm) <- with(metadata, Family) # define the permutation structure considering family
## Full model
print(adonis2(data.dist ~ PAT * outcome * Sex, data = metadata, permutations = perm))
## remove the non significant interactions
print(adonis2(data.dist ~ PAT + outcome + Sex, data = metadata, permutations = perm))
## Remove 1 factor by turn - backwards simplification
# adonis2(data.dist ~ outcome + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + Sex, data = metadata, permutations = perm)
# adonis2(data.dist ~ PAT + outcome, data = metadata, permutations = perm)
}
## Let's run Adonis
myadonisFUN(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
?dist
myNMDSplots <- function(dataset){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
## with paternal treatment
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot))
}
myNMDSplots <- function(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
))
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
## with paternal treatment
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
## with paternal treatment
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
mySEXplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with offspring trt
hulls2 <- ddply(NMDS2, "trtG1G2", find_hull)
myOFFplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=trtG1G2), alpha=0) +
# scale_color_manual(values = c("red","blue"))+
# scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot, mySEXplot, myOFFplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
## with paternal treatment
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
mySEXplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with offspring trt
hulls2 <- ddply(NMDS2, "outcome", find_hull)
myOFFplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=outcome), alpha=0) +
# scale_color_manual(values = c("red","blue"))+
# scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot, mySEXplot, myOFFplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
## with paternal treatment
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
mySEXplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with offspring trt
hulls2 <- ddply(NMDS2, "outcome", find_hull)
myOFFplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=outcome), alpha=0) +
# scale_color_manual(values = c("red","blue"))+
# scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=outcome, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot, mySEXplot, myOFFplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
## with paternal treatment
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
mySEXplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with offspring trt
hulls2 <- ddply(NMDS2, "outcome", find_hull)
myOFFplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=outcome), alpha=0) +
scale_color_manual(values = c("grey","red"))+
scale_fill_manual(values = c("grey","red"))+
geom_point(aes(fill=outcome, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot, mySEXplot, myOFFplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
myNMDSplots <- function(dataset, metadata){
## make percent methylation matrix
x=makePercentMetMat(dataset)
#Create NMDS based on bray-curtis distances - metaMDS finds the
# most stable NMDS solution by randomly starting from different points in your data
set.seed(2)
NMDS <- metaMDS(comm = x, distance = "bray", maxit=1000, k = 6)
#check to see stress of NMDS
mystressplot <- stressplot(NMDS)
#extract plotting coordinates
MDS1 = NMDS$points[,1]
MDS2 = NMDS$points[,2]
## OR #extract NMDS scores (x and y coordinates)
## data.scores = as.data.frame(scores(NMDS))
#create new dataframe with plotting coordinates and variables to test
NMDS2 = data.frame(MDS1 = MDS1, MDS2 = MDS2, ID = metadata$ID,
PAT=as.factor(metadata$PAT),
outcome=as.factor(metadata$outcome),
Sex = as.factor(metadata$Sex))
#function to create convex hulls, though ggplot has the stat_ellipse() function that can do this automatically.
find_hull <- function(my_data) my_data[chull(my_data[,1], my_data[,2]), ]
## with paternal treatment
hulls <- ddply(NMDS2, "PAT", find_hull)
#generating convex hulls by "PAT" in my metadata
myPATplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls, aes(col=PAT), alpha=0) +
scale_color_manual(values = c("grey","yellow"))+
scale_fill_manual(values = c("grey","yellow"))+
geom_point(aes(fill=PAT, shape=PAT), size = 3, alpha = .6) +
#  geom_label(aes(label=row.names(NMDS2)))+
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with Sex
hulls2 <- ddply(NMDS2, "Sex", find_hull)
mySEXplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=Sex), alpha=0) +
scale_color_manual(values = c("red","blue"))+
scale_fill_manual(values = c("red","blue"))+
geom_point(aes(fill=Sex, shape=Sex), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
## with offspring trt
hulls2 <- ddply(NMDS2, "outcome", find_hull)
myOFFplot <- ggplot(NMDS2, aes(x=MDS1, y=MDS2)) +
geom_polygon(data = hulls2, aes(col=outcome), alpha=0) +
scale_color_manual(values = c("grey","red"))+
scale_fill_manual(values = c("grey","red"))+
geom_point(aes(fill=outcome, shape=outcome), size = 3, alpha = .6) +
scale_shape_manual(values = c(21,22)) +
theme_bw() +
theme(legend.title=element_blank(), legend.position = "top")
return(list(mystressplot, myPATplot, mySEXplot, myOFFplot))
}
myNMDSplots(dataset = uniteCovALL_woSexAndUnknowChr_OFF, metadata = fullMetadata_OFFS)
###############################################
### PART 2: Differential methylation sites ####
###############################################
options(stringsAsFactors = FALSE);
table(fullMetadata_OFFS$trtG1G2,fullMetadata_OFFS$trtG1G2_NUM)
## Calculate DMS accounting for covariates: family
cov = data.frame(Family = fullMetadata_PAR$Family)
myDiffMeth=calculateDiffMeth(uniteCov2_woSexAndUnknowChr_PAR,
covariates = cov, mc.cores = 4)
